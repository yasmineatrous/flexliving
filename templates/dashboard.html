{% extends "base.html" %}

{% block title %}Dashboard - Flex Living Reviews{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="fw-bold text-primary">Reviews Dashboard</h1>
    <div class="d-flex gap-2 align-items-center">
        <div id="dataSourceIndicator" class="alert alert-warning mb-0 py-2 px-3" style="display: none;">
            <small><i class="fas fa-exclamation-triangle me-1"></i><span id="dataSourceText"></span></small>
        </div>
        <button class="btn btn-outline-primary" onclick="refreshReviews()">
            <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
    </div>
</div>

<!-- Filters Section -->
<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title mb-3">
            <i class="fas fa-filter me-2"></i>Filters
        </h5>
        
        <div class="row g-3">
            <div class="col-lg-2 col-md-4">
                <label for="ratingFilter" class="form-label">Rating</label>
                <select id="ratingFilter" class="form-select">
                    <option value="">All Ratings</option>
                    <option value="10">10 Stars</option>
                    <option value="9">9+ Stars</option>
                    <option value="8">8+ Stars</option>
                    <option value="7">7+ Stars</option>
                    <option value="6">6+ Stars</option>
                    <option value="5">5+ Stars</option>
                    <option value="4">4+ Stars</option>
                    <option value="3">3+ Stars</option>
                    <option value="2">2+ Stars</option>
                    <option value="1">1+ Stars</option>
                </select>
            </div>
            
            <div class="col-lg-2 col-md-4">
                <label for="categoryFilter" class="form-label">Category</label>
                <select id="categoryFilter" class="form-select">
                    <option value="">All Categories</option>
                    <option value="cleanliness">Cleanliness</option>
                    <option value="communication">Communication</option>
                    <option value="respect_house_rules">House Rules</option>
                    <option value="location">Location</option>
                    <option value="value">Value</option>
                </select>
            </div>
            
            <div class="col-lg-2 col-md-4">
                <label for="channelFilter" class="form-label">Channel</label>
                <select id="channelFilter" class="form-select">
                    <option value="">All Channels</option>
                    <option value="Hostaway">Hostaway</option>
                    <option value="Demo">Demo Data</option>
                    <option value="Google">Google</option>
                </select>
            </div>
            
            <div class="col-lg-3 col-md-6">
                <label for="dateFrom" class="form-label">Date From</label>
                <input type="date" id="dateFrom" class="form-control">
            </div>
            
            <div class="col-lg-3 col-md-6">
                <label for="dateTo" class="form-label">Date To</label>
                <input type="date" id="dateTo" class="form-control">
            </div>
        </div>
        
        <div class="mt-3">
            <button class="btn btn-primary" onclick="applyFilters()">
                <i class="fas fa-search me-1"></i>Apply Filters
            </button>
            <button class="btn btn-outline-secondary ms-2" onclick="clearFilters()">
                <i class="fas fa-times me-1"></i>Clear
            </button>
            <button class="btn btn-outline-danger ms-2" onclick="resetAllApprovals()" id="resetButton">
                <i class="fas fa-undo me-1"></i>Reset All Approvals
            </button>
            <button class="btn btn-outline-success ms-2" onclick="showGoogleApiModal()" id="googleApiButton">
                <i class="fab fa-google me-1"></i>Add Google Reviews
            </button>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingSpinner" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <div class="mt-2">Loading reviews...</div>
</div>

<!-- Reviews Table -->
<div id="reviewsContainer" class="card" style="display: none;">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light sticky-top">
                    <tr>
                        <th class="sortable" data-column="listing_name">
                            Property <i class="fas fa-sort ms-1"></i>
                        </th>
                        <th class="sortable" data-column="guest_name">
                            Guest <i class="fas fa-sort ms-1"></i>
                        </th>
                        <th class="sortable" data-column="overall_rating">
                            Rating <i class="fas fa-sort ms-1"></i>
                        </th>
                        <th class="sortable" data-column="date">
                            Date <i class="fas fa-sort ms-1"></i>
                        </th>
                        <th>Channel</th>
                        <th>Categories</th>
                        <th>Review</th>
                        <th>Approval</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="reviewsTableBody">
                    <!-- Reviews will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Empty State -->
<div id="emptyState" class="text-center py-5" style="display: none;">
    <i class="fas fa-star fa-3x text-muted mb-3"></i>
    <h4 class="text-muted">No Reviews Found</h4>
    <p class="text-muted">No reviews match your current filters or no reviews are available.</p>
</div>

<!-- Google API Key Modal -->
<div class="modal fade" id="googleApiModal" tabindex="-1" aria-labelledby="googleApiModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="googleApiModalLabel">
                    <i class="fab fa-google me-2"></i>Add Google Reviews
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Optional:</strong> Provide your Google Places API key to fetch authentic Google Reviews for your properties. 
                    This requires a Google Cloud account with billing enabled.
                </div>
                
                <div class="mb-3">
                    <label for="googleApiKey" class="form-label">Google Places API Key</label>
                    <input type="password" class="form-control" id="googleApiKey" placeholder="Enter your API key...">
                    <div class="form-text">
                        <i class="fas fa-external-link-alt me-1"></i>
                        <a href="https://developers.google.com/places/web-service/get-api-key" target="_blank">
                            Get your API key from Google Cloud Console
                        </a>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="googlePlaceId" class="form-label">Place ID (Optional)</label>
                    <input type="text" class="form-control" id="googlePlaceId" placeholder="e.g., ChIJd8BlQ2BZwokRAFUEcm_qrcA">
                    <div class="form-text">
                        Leave empty to use default place, or find your specific Place ID using Google's Place ID Finder.
                    </div>
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Note:</strong> Google Places API usage may incur charges. Check Google Cloud pricing before use.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="fetchGoogleReviews()" id="fetchGoogleBtn">
                    <i class="fas fa-download me-1"></i>Fetch Google Reviews
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Error State -->
<div id="errorState" class="alert alert-danger" style="display: none;">
    <i class="fas fa-exclamation-triangle me-2"></i>
    <strong>Error loading reviews:</strong> <span id="errorMessage"></span>
</div>

<!-- Quick Property Access -->
<div class="card mt-4 border-success">
    <div class="card-body">
        <h5 class="card-title text-success">
            <i class="fas fa-home me-2"></i>Property Pages
        </h5>
        <p class="card-text mb-3">View how approved reviews appear on property pages:</p>
        <div id="propertyLinks" class="d-flex flex-wrap gap-2">
            <!-- Property links will be populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Google Integration Notice -->
<div class="card mt-4 border-info">
    <div class="card-body">
        <h5 class="card-title text-info">
            <i class="fab fa-google me-2"></i>Google Reviews Integration
        </h5>
        <p class="card-text">Google Reviews integration is currently pending. This feature will be available in a future update.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
